name: Deploy Nginx (Laravel + PHP å…±ç”¨)

on:
  workflow_dispatch:  # âœ… æ‰‹å‹•è§¸ç™¼

jobs:
  deploy-nginx:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Connect to EC2 and Deploy Nginx
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸ§¨ åœæ­¢ä¸¦ç§»é™¤ç¾æœ‰ nginx_server å®¹å™¨ï¼ˆå¦‚æœæœ‰ï¼‰"
            docker stop nginx_server || true && docker rm nginx_server || true

            echo "ğŸŒ å•Ÿå‹•å…±ç”¨ Nginx å®¹å™¨"
            docker run -d \
              --name nginx_server \
              --network laravel-net \
              --restart unless-stopped \
              -p 80:80 \
              -p 443:443 \
              -v /home/ec2-user/MemberSystemMVC:/var/www/MemberSystemMVC \
              -v /home/ec2-user/laravel-10v:/var/www/laravel-10v \
              -v /home/ec2-user/nginx/default.conf:/etc/nginx/conf.d/default.conf \
              -v /home/ec2-user/ssl:/etc/nginx/ssl \
              -v /home/ec2-user/certbot/www:/var/www/certbot \
              -v /home/ec2-user/certbot/conf:/etc/letsencrypt \
              nginx
            
            echo "âœ… Nginx å·²é‡æ–°éƒ¨ç½²å®Œæˆ"
